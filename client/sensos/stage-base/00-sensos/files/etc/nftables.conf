#!/usr/sbin/nft -f

table inet filter {

  chain input {
    type filter hook input priority 0; policy drop;

    ct state invalid drop
    iifname "lo" accept
    ct state established,related accept

    # ICMP (ping, errors, etc.)
    ip protocol icmp accept
    ip6 nexthdr icmpv6 accept

    # SSH server
    tcp dport 22 accept

    # Inbound WireGuard
    udp dport 51820-51829 accept

    # DHCP requests from AP clients (when acting as DHCP server)
    iifname "wlan0" udp dport 67 accept   # DHCPv4
    iifname "wlan0" udp dport 547 accept  # DHCPv6
  }

  chain forward {
    type filter hook forward priority 0; policy accept;

    # Prevent AP clients from routing off the AP
    iifname "wlan0" oifname != "wlan0" drop
  }

  chain output {
    type filter hook output priority 0; policy drop;

    ct state invalid drop
    oifname "lo" accept
    ct state established,related accept

    # ICMP out (all types)
    ip protocol icmp accept
    ip6 nexthdr icmpv6 accept

    # WireGuard client out
    udp dport 51820-51829 accept

    # NTP
    udp dport 123 accept

    # DHCPv4 client
    udp sport 68 udp dport 67 accept
    ip daddr 255.255.255.255 udp dport 67 accept

    # DHCPv6 client
    udp sport 546 udp dport 547 accept

    # DHCP replies to AP clients (when acting as DHCP server)
    oifname "wlan0" udp sport 67  udp dport 68  accept   # v4
    oifname "wlan0" udp sport 547 udp dport 546 accept   # v6
  }
}

include "/sensos/etc/sensos-ports.nft"
