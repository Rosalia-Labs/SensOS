#!/bin/bash
set -e

script_name=$(basename "$0")

source /sensos/lib/load-defaults.sh
source /sensos/lib/parse-switches.sh

arecord_conf=/sensos/etc/arecord.conf

declare -A default_vars
load_defaults "$script_name" default_vars

get_default() {
    local varname="$1"
    local fallback="$2"
    echo "${default_vars[$varname]:-$fallback}"
}

# Load values from arecord.conf if available
if [[ -f "$arecord_conf" ]]; then
    echo "Reading config from $arecord_conf..."
    audio_directory=$(grep '^BASE_DIR=' "$arecord_conf" | cut -d= -f2- | tr -d '"')
    audio_format_code=$(grep '^FORMAT=' "$arecord_conf" | cut -d= -f2- | tr -d '"')
fi

# Final fallbacks
audio_directory="${audio_directory:-/sensos/data/audio_recordings}"
audio_format_code="${audio_format_code:-S32_LE}"

register_option --build build_missing "Build images if no tarball is found" "$(get_default build_missing false)"
register_option --force force_build "Force rebuild of all images" "$(get_default force_build false)"
register_option --postgres-db postgres_db "Set database name" "$(get_default postgres_db postgres)"
register_option --postgres-user postgres_user "Set database user" "$(get_default postgres_user postgres)"
register_option --postgres-password postgres_password "Set database password" "$(get_default postgres_password sensos)"
register_option --db-host db_host "Set database host" "$(get_default db_host sensos-client-database)"
register_option --db-port db_port "Set database port" "$(get_default db_port 5432)"
register_option --db-data-path db_data_path "Set Docker volume path" "$(get_default db_data_path /sensos/data/database)"
register_option --audio-directory audio_directory "Path for audio files" "$(get_default audio_directory)"
register_option --audio-format audio_format_code "ALSA audio format code" "$(get_default audio_format_code)"
register_option --enable-service enable_service "Enable systemd service" "$(get_default enable_service true)"
register_option --start-service start_service "Start systemd service" "$(get_default start_service false)"

parse_switches "$script_name" "$@"

# Ensure output directory exists
docker_compose_dir=/sensos/docker
mkdir -p "$docker_compose_dir"
if [[ ! -w "$docker_compose_dir" ]]; then
    echo "ERROR: Cannot write to $docker_compose_dir"
    exit 1
fi

# Load or build Docker images
echo "🔍 Checking Docker images in $docker_compose_dir..."
dockerfile_dirs=$(find "$docker_compose_dir" -type f -name 'Dockerfile' -exec dirname {} \;)

for dir in $dockerfile_dirs; do
    image_tag="sensos-$(basename "$dir" | tr '_' '-')"
    tarball_gz="$dir/${image_tag}.tar.gz"
    tarball_plain="$dir/${image_tag}.tar"

    if [[ "$force_build" == "true" ]]; then
        echo "🔁 Forcing rebuild of $image_tag..."
        docker build -t "$image_tag" "$dir"
        continue
    fi

    if [[ -f "$tarball_gz" ]]; then
        echo "💾 Loading $image_tag from $tarball_gz..."
        gunzip -c "$tarball_gz" | docker load
    elif [[ -f "$tarball_plain" ]]; then
        echo "💾 Loading $image_tag from $tarball_plain..."
        docker load -i "$tarball_plain"
    elif [[ "$build_missing" == "true" ]]; then
        echo "🛠️ Building $image_tag from $dir (missing tarball)..."
        docker build -t "$image_tag" "$dir"
    else
        echo "⚠️  No image or tarball found for $image_tag — skipping (use --build or --force to build)."
    fi
done

echo "🔍 Verifying that all required Docker images are present..."
missing_images=()

for dir in $dockerfile_dirs; do
    image_tag="sensos-$(basename "$dir" | tr '_' '-')"
    if ! docker image inspect "$image_tag" >/dev/null 2>&1; then
        missing_images+=("$image_tag")
    fi
done

if [[ "${#missing_images[@]}" -gt 0 ]]; then
    echo "❌ The following images are missing and required for systemd to run with --no-build:"
    for img in "${missing_images[@]}"; do
        echo "   - $img"
    done
    echo "💡 Rerun this script with --build or --force to fix."
    exit 1
else
    echo "✅ All required images are available."
fi

# Write .env file
env_file="$docker_compose_dir/.env"
cat >"$env_file" <<EOF
POSTGRES_DB=${postgres_db}
POSTGRES_USER=${postgres_user}
POSTGRES_PASSWORD=${postgres_password}
DB_HOST=${db_host}
DB_PORT=${db_port}
DB_DATA_PATH=${db_data_path}
AUDIO_DIRECTORY=${audio_directory}
AUDIO_FORMAT_CODE=${audio_format_code}
EOF

echo ".env written to $env_file:"
cat "$env_file"

# Enable/start service
if [[ "$enable_service" == "true" ]]; then
    echo "Enabling sensos-docker.service..."
    sudo systemctl daemon-reload
    sudo systemctl enable sensos-docker.service
fi

if [[ "$start_service" == "true" ]]; then
    echo "Starting sensos-docker.service..."
    sudo systemctl daemon-reload
    sudo systemctl start sensos-docker.service
fi
