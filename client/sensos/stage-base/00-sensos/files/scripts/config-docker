#!/bin/bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Rosalia Labs LLC

set -e

script_name=$(basename "$0")

source /sensos/lib/load-defaults.sh
source /sensos/lib/parse-switches.sh
source /sensos/lib/docker-utils.sh

declare -A default_vars
load_defaults "$script_name" default_vars

get_default() {
    local varname="$1"
    local fallback="$2"
    echo "${default_vars[$varname]:-$fallback}"
}

register_option --birdnet-score-threshold birdnet_score_threshold "Set BirdNET score threshold for deletion" "$(get_default birdnet_score_threshold 0.1)"
register_option --build-containers build_containers "Call build containers to load docker images" "$(get_default build_containers true)"
register_option --enable-service enable_service "Enable systemd service" "$(get_default enable_service true)"
register_option --start-service start_service "Start systemd service" "$(get_default start_service false)"
register_option --postgres-db postgres_db "Set database name" "$(get_default postgres_db postgres)"
register_option --postgres-user postgres_user "Set database user" "$(get_default postgres_user postgres)"
register_option --postgres-password postgres_password "Set database password" "$(get_default postgres_password sensos)"
register_option --db-host db_host "Set database host" "$(get_default db_host sensos-client-database)"
register_option --db-port db_port "Set database port" "$(get_default db_port 5432)"
register_option --db-data-path db_data_path "Set Docker volume path" "$(get_default db_data_path /sensos/data/database)"
register_option --dashboard-port dashboard_port "Set dashboard host port" "$(get_default dashboard_port 8090)"
register_option --dashboard-user dashboard_user "Set dashboard basic auth username" "$(get_default dashboard_user sensos)"
register_option --dashboard-password dashboard_password "Set dashboard basic auth password" "$(get_default dashboard_password change-me)"
register_option --dashboard-db-user dashboard_db_user "Set dashboard read-only DB username" "$(get_default dashboard_db_user sensos_dashboard_ro)"
register_option --dashboard-db-password dashboard_db_password "Set dashboard read-only DB password" "$(get_default dashboard_db_password sensos_dashboard_readonly)"
register_option --dashboard-db-bootstrap dashboard_db_bootstrap "Auto-create read-only DB role for dashboard" "$(get_default dashboard_db_bootstrap true)"
register_option --dashboard-window-hours dashboard_window_hours "Rolling dashboard time window in hours" "$(get_default dashboard_window_hours 24)"

parse_switches "$script_name" "$@"

env_file="/sensos/docker/.env"
cat >"$env_file" <<EOF
POSTGRES_DB=${postgres_db}
POSTGRES_USER=${postgres_user}
POSTGRES_PASSWORD=${postgres_password}
DB_HOST=${db_host}
DB_PORT=${db_port}
DB_DATA_PATH=${db_data_path}
BIRDNET_SCORE_THRESHOLD=${birdnet_score_threshold}
DASHBOARD_PORT=${dashboard_port}
DASHBOARD_USER=${dashboard_user}
DASHBOARD_PASSWORD=${dashboard_password}
DASHBOARD_DB_USER=${dashboard_db_user}
DASHBOARD_DB_PASSWORD=${dashboard_db_password}
DASHBOARD_DB_BOOTSTRAP=${dashboard_db_bootstrap}
DASHBOARD_WINDOW_HOURS=${dashboard_window_hours}
EOF

echo ".env written to $env_file:"
cat "$env_file"

if [[ "$build_containers" == "true" ]]; then
    echo "Building docker images..."
    build-containers
else
    echo "Now call build-containers to prepare docker."
fi

if [[ "$enable_service" == "true" ]]; then
    echo "Enabling sensos-container.service..."
    sudo systemctl daemon-reload
    sudo systemctl enable sensos-container.service
fi

if [[ "$start_service" == "true" ]]; then
    echo "Starting sensos-container.service..."
    sudo systemctl daemon-reload
    sudo systemctl start sensos-container.service
fi
