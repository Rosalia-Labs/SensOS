#!/bin/bash
set -e

script_name=$(basename "$0")

source /sensos/lib/load-defaults.sh
source /sensos/lib/parse-switches.sh

declare -A default_vars
load_defaults "$script_name" default_vars

get_default() {
    local varname="$1"
    local fallback="$2"
    echo "${default_vars[$varname]:-$fallback}"
}

# Load values from arecord.conf if available
if [[ -f "$arecord_conf" ]]; then
    echo "Reading config from $arecord_conf..."
    audio_directory=$(grep '^BASE_DIR=' "$arecord_conf" | cut -d= -f2- | tr -d '"')
    audio_format_code=$(grep '^FORMAT=' "$arecord_conf" | cut -d= -f2- | tr -d '"')
fi

# Final fallbacks
audio_directory="${audio_directory:-/sensos/data/audio_recordings}"
audio_format_code="${audio_format_code:-S32_LE}"

# Possible values: offline, fallback, prefer-cache, force-download
register_option --download-mode download_mode "Set download mode (offline, fallback, prefer-cache, force-download)" "$(get_default download_mode fallback)"
register_option --postgres-db postgres_db "Set database name" "$(get_default postgres_db postgres)"
register_option --postgres-user postgres_user "Set database user" "$(get_default postgres_user postgres)"
register_option --postgres-password postgres_password "Set database password" "$(get_default postgres_password sensos)"
register_option --db-host db_host "Set database host" "$(get_default db_host sensos-client-database)"
register_option --db-port db_port "Set database port" "$(get_default db_port 5432)"
register_option --db-data-path db_data_path "Set Docker volume path" "$(get_default db_data_path /sensos/data/database)"
register_option --audio-directory audio_directory "Path for audio files" "$(get_default audio_directory)"
register_option --audio-format audio_format_code "ALSA audio format code" "$(get_default audio_format_code)"
register_option --enable-service enable_service "Enable systemd service" "$(get_default enable_service true)"
register_option --start-service start_service "Start systemd service" "$(get_default start_service false)"

parse_switches "$script_name" "$@"

# Handle download mode logic
case "$download_mode" in
offline)
    ENABLE_DOWNLOADS=false
    REQUIRE_CACHE=true
    CLEAR_CACHE_FIRST=false
    ;;
fallback)
    ENABLE_DOWNLOADS=true
    REQUIRE_CACHE=false
    CLEAR_CACHE_FIRST=false
    ;;
prefer-cache)
    ENABLE_DOWNLOADS=false
    REQUIRE_CACHE=false
    CLEAR_CACHE_FIRST=false
    ;;
force-download)
    ENABLE_DOWNLOADS=true
    REQUIRE_CACHE=false
    CLEAR_CACHE_FIRST=true
    ;;
*)
    echo "âŒ Invalid download_mode: $download_mode"
    exit 1
    ;;
esac

# Ensure output directory exists
docker_compose_dir=/sensos/docker
mkdir -p "$docker_compose_dir"
if [[ ! -w "$docker_compose_dir" ]]; then
    echo "ERROR: Cannot write to $docker_compose_dir"
    exit 1
fi

# Load Docker image tarballs (always allowed)
echo "ğŸ” Scanning for Docker base images to load from cache..."
dockerfile_dirs=$(find "$docker_compose_dir" -type f -name 'Dockerfile' -exec dirname {} \;)
found_any=false

while IFS= read -r dir; do
    for tarball in "$dir"/*.tar "$dir"/*.tar.gz; do
        [[ -f "$tarball" ]] || continue
        case "$tarball" in
        *.tar.gz)
            echo "ğŸ’¾ Loading compressed Docker image from $tarball..."
            if gunzip -t "$tarball" 2>/dev/null; then
                gunzip -c "$tarball" | docker load
                found_any=true
            else
                echo "âŒ Invalid gzip file: $tarball â€” skipping."
            fi
            ;;
        *.tar)
            echo "ğŸ’¾ Loading uncompressed Docker image from $tarball..."
            docker load -i "$tarball"
            found_any=true
            ;;
        esac
    done
done <<<"$dockerfile_dirs"

if [[ "$found_any" == "false" ]]; then
    if [[ "$REQUIRE_CACHE" == "true" ]]; then
        echo "âŒ No cached Docker images found, and download_mode=offline requires them."
        exit 1
    else
        echo "âš ï¸  No Docker base images loaded from local tarballs."
    fi
else
    echo "âœ… All available Docker base images loaded successfully."
fi

# Write .env file
env_file="$docker_compose_dir/.env"
cat >"$env_file" <<EOF
POSTGRES_DB=${postgres_db}
POSTGRES_USER=${postgres_user}
POSTGRES_PASSWORD=${postgres_password}
DB_HOST=${db_host}
DB_PORT=${db_port}
DB_DATA_PATH=${db_data_path}
AUDIO_DIRECTORY=${audio_directory}
AUDIO_FORMAT_CODE=${audio_format_code}
DOWNLOAD_MODE=${download_mode}
EOF

echo ".env written to $env_file:"
cat "$env_file"

# Enable and optionally start service
echo "Reloading systemd..."
sudo systemctl daemon-reload

if [[ "$enable_service" == "true" ]]; then
    echo "Enabling sensos-docker.service..."
    sudo systemctl enable sensos-docker.service
fi

if [[ "$start_service" == "true" ]]; then
    echo "Starting sensos-docker.service..."
    sudo systemctl start sensos-docker.service
fi
