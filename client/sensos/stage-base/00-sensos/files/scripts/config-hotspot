#!/bin/bash
set -e

script_name=$(basename "$0")
config_dir="/sensos/etc"
config_file="$config_dir/access_point.conf"
log_dir="/sensos/log"

source /sensos/lib/load-defaults.sh
source /sensos/lib/parse-switches.sh

declare -A default_vars
load_defaults "$script_name" default_vars

get_default() {
    local varname="$1"
    local fallback="$2"
    echo "${default_vars[$varname]:-$fallback}"
}

default_ssid=$(hostname | sed 's/-/_/g')
register_option --ssid ssid "WiFi SSID (required)" "$(get_default ssid "$default_ssid")"
register_option --password password "WiFi password (8â€“63 chars, required)" "$(get_default password)"
register_option --power-save power_save "Enable WiFi power management" "$(get_default power_save false)"
register_option --interface interface "Wireless interface to use" "$(get_default interface wlan0)"
register_option --enable-service enable_service "Enable sensos-hotspot.service" "$(get_default enable_service true)"
register_option --start-service start_service "Start sensos-hotspot.service" "$(get_default start_service false)"

# Parse CLI
parse_switches "$script_name" "$@"

# Validate required args
if [[ -z "$ssid" || -z "$password" ]]; then
    echo "ERROR: Both --ssid and --password are required."
    exit 1
fi

if [[ ${#password} -lt 8 || ${#password} -gt 63 ]]; then
    echo "ERROR: WPA2 password must be between 8 and 63 characters."
    exit 1
fi

# Ensure necessary directories exist
mkdir -p "$config_dir" "$log_dir"

# Write config file for start-hotspot.sh
{
    echo "ssid = $ssid"
    echo "password = $password"
    echo "power_save = $power_save"
    echo "interface = $interface"
} >"$config_file"

echo "âœ… WiFi access point config written to $config_file."

if [[ "$enable_service" == "true" ]]; then
    echo "Enabling sensos-hotspot.service..."
    sudo systemctl enable sensos-hotspot.service

    echo "Disabling auto-hotspot.service (will stay active until stopped)..."
    sudo systemctl disable auto-hotspot.service || true

    echo "Enabling ssh.service..."
    sudo systemctl enable ssh

    echo "â„¹ï¸  auto-hotspot.service is still running for now and will be stopped after the switch."
fi

if [[ "$start_service" == "true" ]]; then
    echo "âš ï¸  The device is about to switch WiFi networks."
    echo "ğŸ“¶ A new access point with SSID '$ssid' will be enabled."
    echo "ğŸ’¡ Please log out now and reconnect to the new network once it appears."
    echo "â³ Waiting 10 seconds before switching..."

    (
        sleep 10
        echo "ğŸ”„ Reloading systemd before switching..." | tee -a "$LOG_FILE"
        sudo systemctl daemon-reexec
        sudo systemctl daemon-reload

        echo "ğŸ”Œ Stopping auto-hotspot.service..." | tee -a "$LOG_FILE"
        sudo systemctl stop auto-hotspot.service

        echo "ğŸš€ Starting sensos-hotspot.service..." | tee -a "$LOG_FILE"
        sudo systemctl start sensos-hotspot.service

        echo "ğŸ” Starting ssh.service..." | tee -a "$LOG_FILE"
        sudo systemctl start ssh

        echo "âœ… Access point switch complete." | tee -a "$LOG_FILE"
    ) &
fi
