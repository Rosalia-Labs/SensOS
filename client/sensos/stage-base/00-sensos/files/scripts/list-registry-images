#!/bin/bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Rosalia Labs LLC

# registry-list.sh
# This script lists repositories and tags from the sensos registry.
# It accepts command-line options to override default connection parameters.
# It uses jq for JSON parsing if available.

set -e

# Default values
SENSOS_REGISTRY_IP="localhost"
SENSOS_REGISTRY_PORT=5000
SENSOS_REGISTRY_USER="sensos"
SENSOS_REGISTRY_PASSWORD="sensos"

usage() {
    echo "Usage: $0 [--registry-ip IP] [--registry-port PORT] [--registry-user USER] [--registry-password PASS]"
    exit 1
}

# Parse command-line arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
    --registry-ip)
        SENSOS_REGISTRY_IP="$2"
        shift 2
        ;;
    --registry-port)
        SENSOS_REGISTRY_PORT="$2"
        shift 2
        ;;
    --registry-user)
        SENSOS_REGISTRY_USER="$2"
        shift 2
        ;;
    --registry-password)
        SENSOS_REGISTRY_PASSWORD="$2"
        shift 2
        ;;
    --help)
        usage
        ;;
    *)
        echo "Unknown option: $1"
        usage
        ;;
    esac
done

echo "Using registry IP: $SENSOS_REGISTRY_IP"

# Define the registry URL (using HTTP, since TLS is removed)
REGISTRY="http://$SENSOS_REGISTRY_IP:$SENSOS_REGISTRY_PORT"

# Check if jq is available
if command -v jq >/dev/null 2>&1; then
    # Use jq to parse the catalog JSON
    REPOS=$(curl -s -u "$SENSOS_REGISTRY_USER:$SENSOS_REGISTRY_PASSWORD" "$REGISTRY/v2/_catalog" | jq -r '.repositories[]?')
else
    # Fallback to grep/cut parsing if jq isn't available
    REPOS=$(curl -s -u "$SENSOS_REGISTRY_USER:$SENSOS_REGISTRY_PASSWORD" "$REGISTRY/v2/_catalog" |
        grep -o '"repositories":\[[^]]*' | cut -d '[' -f2 | tr -d '"]' | tr ',' '\n')
fi

# Split the output into two clear cases:
if [ -z "$REPOS" ]; then
    echo "No repositories found."
    exit 1
fi

echo "Repositories found:"
# List images and their tags
for repo in $REPOS; do
    echo "Image: $repo"
    if command -v jq >/dev/null 2>&1; then
        TAGS=$(curl -s -u "$SENSOS_REGISTRY_USER:$SENSOS_REGISTRY_PASSWORD" "$REGISTRY/v2/$repo/tags/list" | jq -r '.tags[]?')
    else
        TAGS=$(curl -s -u "$SENSOS_REGISTRY_USER:$SENSOS_REGISTRY_PASSWORD" "$REGISTRY/v2/$repo/tags/list" |
            grep -o '"tags":\[[^]]*' | cut -d '[' -f2 | tr -d '"]' | tr ',' '\n')
    fi
    if [ -z "$TAGS" ]; then
        echo "  (No tags found)"
    else
        for tag in $TAGS; do
            echo "  - $tag"
        done
    fi
done
