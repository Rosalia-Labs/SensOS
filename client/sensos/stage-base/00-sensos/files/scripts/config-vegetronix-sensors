#!/bin/bash
set -e

script_name=$(basename "$0")

source /sensos/lib/load-defaults.sh
source /sensos/lib/parse-switches.sh

config_path="/sensos/etc/vegetronix-sensors.conf"
mkdir -p /sensos/etc

declare -A default_vars
load_defaults "/sensos/etc/defaults.conf" "$script_name" default_vars

get_default() {
    local varname="$1"
    local fallback="$2"
    echo "${default_vars[$varname]:-$fallback}"
}

# Register known channels A0 through A7
for ch in {0..7}; do
    register_option "--A$ch" "A$ch" "Label for Vegetronix channel A$ch" "$(get_default A$ch "")"
done

parse_switches "$script_name" "$@"

echo "Writing Vegetronix config to $config_path..."
{
    echo "# Auto-generated by $script_name"
    for ch in {0..7}; do
        var="A$ch"
        val="${!var:-}"
        [[ -n "$val" ]] && echo "$var=$val"
    done
} >"$config_path"

echo "Done. Config contents:"
cat "$config_path"
