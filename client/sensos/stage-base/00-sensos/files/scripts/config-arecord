#!/bin/bash
# config-arecord.sh: Write arecord configuration to $SENSOS_USER's etc directory

Usage() {
    cat <<EOF
Usage: $0 [options]

Required:
  --device DEVICE         Recording device string (e.g., plughw:1,0)
  --format FORMAT         Recording format (e.g., S16_LE)
  --channels CHANNELS     Channel count (e.g., 2)

Optional:
  --rate RATE             Sample rate in Hz (default: 48000)
  --max-time SECONDS      Max duration per file (default: 900)
  --base-dir DIR          Base directory for sound files (default: ~SENSOS_USER/audio_recordings/unprocessed)
  --help                  Show this help message
EOF
}

# Require SENSOS_USER to be set
if [[ -z "$SENSOS_USER" ]]; then
    echo "ERROR: SENSOS_USER is not set in the environment."
    exit 1
fi

# Determine home directory
SENSOS_HOME=$(eval echo "~$SENSOS_USER")

# Defaults
device=""
format=""
channels=""
rate="48000"
max_time="900"
base_dir="$SENSOS_HOME/audio_recordings/unprocessed"

# Parse arguments
TEMP=$(getopt -o "" \
    --long device:,format:,channels:,rate:,max-time:,base-dir:,help \
    -n 'config-arecord.sh' -- "$@")

if [ $? != 0 ]; then
    Usage
    exit 1
fi

eval set -- "$TEMP"

# Process options
while true; do
    case "$1" in
    --device)
        device="$2"
        shift 2
        ;;
    --format)
        format="$2"
        shift 2
        ;;
    --channels)
        channels="$2"
        shift 2
        ;;
    --rate)
        rate="$2"
        shift 2
        ;;
    --max-time)
        max_time="$2"
        shift 2
        ;;
    --base-dir)
        base_dir="$2"
        shift 2
        ;;
    --help)
        Usage
        exit 0
        ;;
    --)
        shift
        break
        ;;
    *)
        echo "Unknown option: $1"
        Usage
        exit 1
        ;;
    esac
done

# Validate required options
missing=()
[ -z "$device" ] && missing+=("--device")
[ -z "$format" ] && missing+=("--format")
[ -z "$channels" ] && missing+=("--channels")

if [ ${#missing[@]} -gt 0 ]; then
    echo "ERROR: Missing required options: ${missing[*]}" >&2
    Usage
    exit 1
fi

# Write config
config_dir="$SENSOS_HOME/etc"
mkdir -p "$config_dir"
config_file="$config_dir/arecord.conf"

cat >"$config_file" <<EOF
# Auto-generated arecord configuration
DEVICE="$device"
FORMAT="$format"
CHANNELS=$channels
RATE=$rate
MAX_TIME=$max_time
BASE_DIR="$base_dir"
EOF

echo "Configuration written to $config_file"

echo "Enabling and starting sensos-arecord.service..."
sudo systemctl daemon-reload
sudo systemctl enable sensos-arecord.service
sudo systemctl start sensos-arecord.service
