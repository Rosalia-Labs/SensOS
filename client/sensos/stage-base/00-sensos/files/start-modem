#!/bin/bash

# Read first user from /etc/sensos/first-user-name.conf or fallback to UID 1000
FIRST_USER=$(cat /etc/sensos/first-user-name.conf 2>/dev/null || id -nu 1000)
USER_HOME=$(eval echo ~$FIRST_USER)

CONFIG_FILE="/etc/sensos/modem.conf"
LOG_DIR="$USER_HOME/logs"
LOG_FILE="$LOG_DIR/modem.log"

# Ensure the log directory exists
mkdir -p "$LOG_DIR"

# Ensure the config file exists
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: Modem configuration file $CONFIG_FILE not found." | tee -a "$LOG_FILE"
    exit 1
fi

# Load modem configuration
source "$CONFIG_FILE"

# Check if nmcli is available
if ! command -v nmcli >/dev/null; then
    echo "Error: nmcli command not found. Please install NetworkManager." | tee -a "$LOG_FILE"
    exit 1
fi

# Bring up the LTE connection if not already active
while true; do
    # Check if the connection exists
    if nmcli connection show "lte" >/dev/null 2>&1; then
        STATUS=$(nmcli device status | grep "$MODEM_IFACE" | awk '{print $3}')
        if [[ "$STATUS" == "connected" ]]; then
            echo "LTE connection is up." | tee -a "$LOG_FILE"
        else
            echo "Reconnecting LTE modem..." | tee -a "$LOG_FILE"
            nmcli c up "lte"
        fi
    else
        echo "Creating new LTE connection..." | tee -a "$LOG_FILE"
        nmcli c add type gsm ifname "$MODEM_IFACE" con-name "lte" \
            connection.interface-name "$MODEM_INTERNAL_NAME" gsm.apn "$APN" ipv4.method auto
        nmcli c up "lte"
    fi

    # Check every 30 seconds
    sleep 30
done
