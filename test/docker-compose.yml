name: sensos-test

services:
  dind:
    image: docker:27-dind
    container_name: sensos-test-dind
    hostname: docker                  
    networks:
      sensos-test-net:
        aliases: ["docker"]           
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: /certs
    volumes:
      - dind-graph:/var/lib/docker
      - dind-certs:/certs
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 3s
      timeout: 2s
      retries: 20

  server:
    build:
      context: ..
      dockerfile: test/server/Dockerfile
    container_name: sensos-test-server
    networks: [sensos-test-net]
    depends_on:
      dind:
        condition: service_healthy
    environment:
      DOCKER_HOST: tcp://docker:2376  
      DOCKER_TLS_VERIFY: "1"
      DOCKER_TLS_CERTDIR: /certs
      DOCKER_CERT_PATH: /certs/client
      COMPOSE_PROJECT_NAME: sensos_srv_test
    volumes:
      - dind-certs:/certs:ro
    working_dir: /srv/sensos-server   
    tty: true
    stdin_open: true
    command: >
      bash -lc '
        set -euo pipefail;
        ln -s /srv/sensos-server /srv/server 2>/dev/null || true;
        cd /srv/sensos-server/bin;
        ./configure-server.sh --wg-server-ip wireguard;
        ./start-server.sh;
        tail -f /dev/null
      '

  client:
    build:
      context: ..
      dockerfile: test/client/Dockerfile
    container_name: sensos-test-client
    networks: [sensos-test-net]
    depends_on:
      dind:
        condition: service_healthy
      server:
        condition: service_started
    environment:
      DOCKER_HOST: tcp://docker:2376  
      DOCKER_TLS_VERIFY: "1"
      DOCKER_TLS_CERTDIR: /certs
      DOCKER_CERT_PATH: /certs/client
    volumes:
      - dind-certs:/certs:ro
    tty: true
    stdin_open: true

networks:
  sensos-test-net:
    driver: bridge

volumes:
  dind-graph:
  dind-certs:
